<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orator Trainer — Demo (with Timer)</title>
  <style>
    :root{--bg:#071827;--card:#08141c;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#041428 0%, #071827 60%);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial;color:#dbeafe}
    .wrap{max-width:980px;margin:36px auto;padding:20px}
    header{display:flex;align-items:center;gap:18px}
    header h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;color:#e6eef8;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    button{background:var(--accent);border:none;color:#042022;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .controls{display:flex;gap:8px;margin-top:8px}
    #transcript{min-height:140px;white-space:pre-wrap;background:var(--glass);padding:12px;border-radius:8px;color:#e6eef8}
    .metrics{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .metric{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px;border-radius:8px;min-width:120px}
    .history-list{max-height:300px;overflow:auto;margin-top:10px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .suggestion{background:rgba(6,182,212,0.06);color:var(--accent);padding:8px;border-radius:8px;margin-top:10px}
    .small{font-size:13px;color:var(--muted)}

    /* timer */
    .timer-wrap{display:flex;align-items:center;gap:12px}
    .progress{height:12px;background:rgba(255,255,255,0.03);border-radius:8px;flex:1;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#38bdf8);width:0%}
    .time-display{min-width:64px;text-align:right;font-weight:700}

    .smallBtn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 8px;border-radius:6px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" aria-hidden><rect width="24" height="24" rx="6" fill="#04303a"/><path d="M6 15s2-2 6-2 6 2 6 2" stroke="#06b6d4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>
        <h1>Orator Trainer — Classroom Demo (Timer)</h1>
        <div class="small">Record with a countdown, live transcript, metrics, and history — runs fully in-browser.</div>
      </div>
    </header>

    <div class="grid">
      <main class="card">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <div>
            <strong>Live Practice</strong>
            <div class="small">Pick a prompt, press Start, speak naturally during the timer.</div>
          </div>
          <div class="small" id="status">● idle</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <select id="prompt" style="flex:1;padding:10px;border-radius:8px;background:transparent;color:#e6eef8;border:1px solid rgba(255,255,255,0.04)">
            <option data-seconds="60">60s: Personal intro</option>
            <option data-seconds="45">45s: Explain your favourite concept</option>
            <option data-seconds="30">30s: Pitch a product</option>
            <option data-seconds="60">60s: Tell a brief story</option>
            <option data-seconds="30">30s: Explain like I'm 10</option>
          </select>

          <div style="min-width:220px">
            <div class="timer-wrap" style="margin-bottom:8px">
              <div class="progress" aria-hidden><i id="progressBar"></i></div>
              <div class="time-display" id="timeLeft">00:00</div>
            </div>
            <div class="small" style="text-align:right">Auto-stops when timer ends</div>
          </div>
        </div>

        <div class="controls">
          <button id="startBtn">Start</button>
          <button id="stopBtn" class="secondary" disabled>Stop</button>
          <button id="saveBtn" class="secondary" disabled>Save session</button>
          <button id="exportBtn" class="secondary">Export CSV</button>
        </div>

        <div id="transcript" contenteditable="true" aria-live="polite">(transcript appears here)</div>

        <div class="metrics" id="metrics"></div>

        <div class="suggestion" id="suggestion" style="display:none"></div>
      </main>

      <aside class="card">
        <strong>History</strong>
        <div class="history-list" id="history"></div>
        <div style="margin-top:10px">
          <strong>Session controls</strong>
          <div class="small">You can replay transcripts or clear history.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="clearHistory" class="secondary">Clear</button>
            <button id="demoFill" class="secondary">Insert demo speech</button>
          </div>
        </div>
      </aside>
    </div>

    <footer class="card small">Notes: for microphone access use Chrome or Edge. If recognition isn't available you can paste text into the transcript box and save. Everything stores locally in your browser.</footer>
  </div>

  <script>
  // Enhanced Orator Trainer: Timer + Progress Bar
  const $ = id => document.getElementById(id);
  const FILLERS = ['um','uh','like','you know','actually','basically','right','so','i mean','kind of','sort of'];

  let recognition = null, recognizing=false, mediaStream=null, audioContext=null;
  let finalTranscript = '';
  let startTime=0, endTime=0, timerId=null, totalMs=0;
  let pauses=[], lastSpeechTime=0, pitchSamples=[];

  const startBtn = $('startBtn'), stopBtn=$('stopBtn'), saveBtn=$('saveBtn'), exportBtn=$('exportBtn');
  const transcriptEl=$('transcript'), statusEl=$('status'), metricsEl=$('metrics'), suggestionEl=$('suggestion');
  const historyEl=$('history'), promptEl=$('prompt'), progressBar=$('progressBar'), timeLeftEl=$('timeLeft');

  function supportsSpeechRecognition(){ return !!(window.SpeechRecognition || window.webkitSpeechRecognition); }

  function getSelectedSeconds(){ const opt = promptEl.selectedOptions[0]; return parseInt(opt.dataset.seconds||30,10); }

  function formatMs(ms){ const s = Math.ceil(ms/1000); const mm = Math.floor(s/60); const ss = s%60; return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }

  function startTimer(seconds){ totalMs = seconds*1000; startTime = performance.now(); endTime = startTime + totalMs; updateTimer(); timerId = requestAnimationFrame(tick); }
  function tick(){ const now = performance.now(); const remaining = Math.max(0, endTime - now); const pct = Math.min(100, 100*((totalMs - remaining)/totalMs)); progressBar.style.width = pct + '%'; timeLeftEl.textContent = formatMs(remaining); if (remaining<=0){ stopRecording(); return; } timerId = requestAnimationFrame(tick); }
  function updateTimer(){ timeLeftEl.textContent = formatMs(totalMs); progressBar.style.width = '0%'; }

  // Speech recognition
  function startRecognition(){
    if (!supportsSpeechRecognition()){ alert('SpeechRecognition not available. Paste text manually or use demo speech.'); return; }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR(); recognition.interimResults = true; recognition.continuous = true; recognition.lang='en-US';
    finalTranscript = ''; transcriptEl.textContent = '';

    recognition.onstart = ()=>{ recognizing=true; statusEl.textContent='● listening'; stopBtn.disabled=false; startBtn.disabled=true; saveBtn.disabled=true; lastSpeechTime = performance.now(); pauses=[]; pitchSamples=[]; };
    recognition.onresult = (ev)=>{
      let interim='';
      for (let i=ev.resultIndex;i<ev.results.length;i++){
        const r = ev.results[i]; if (r.isFinal){ finalTranscript += r[0].transcript + ' '; speechDetected(); } else interim += r[0].transcript;
      }
      transcriptEl.textContent = (finalTranscript + '\n' + interim).trim(); computeLiveMetrics();
    };
    recognition.onerror = (e)=>{ console.warn('rec error', e); };
    recognition.onend = ()=>{ recognizing=false; statusEl.textContent='● idle'; stopBtn.disabled=true; startBtn.disabled=false; saveBtn.disabled = finalTranscript.trim().length===0; stopAudioCapture(); if (timerId) cancelAnimationFrame(timerId); };
    recognition.start(); startAudioCapture();
  }

  function stopRecognition(){ if (recognition) recognition.stop(); }

  async function startAudioCapture(){ try{ mediaStream = await navigator.mediaDevices.getUserMedia({audio:true}); audioContext = new (window.AudioContext||window.webkitAudioContext)(); const source = audioContext.createMediaStreamSource(mediaStream); const analyser = audioContext.createAnalyser(); analyser.fftSize = 2048; source.connect(analyser); const data = new Float32Array(analyser.fftSize);
      function sample(){ analyser.getFloatTimeDomainData(data); const rms = Math.sqrt(data.reduce((s,v)=>s+v*v,0)/data.length); const now = performance.now(); if (rms>0.01){ lastSpeechTime = now; const p = autoCorrelate(data, audioContext.sampleRate); if (p && p>50 && p<600) pitchSamples.push(p); } else { const silence = now - lastSpeechTime; if (silence>400 && (pauses.length===0 || (now - pauses[pauses.length-1].end)>300)){ pauses.push({start:lastSpeechTime,end:now}); } }
      if (recognizing) requestAnimationFrame(sample); }
    requestAnimationFrame(sample);
    }catch(e){ console.warn('mic fail', e); }
  }
  function stopAudioCapture(){ if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } if (audioContext){ audioContext.close(); audioContext=null; } }

  function autoCorrelate(buf, sampleRate){ const SIZE=buf.length; let rms=0; for (let i=0;i<SIZE;i++){ rms+=buf[i]*buf[i]; } rms=Math.sqrt(rms/SIZE); if (rms<0.01) return null; let r1=0,r2=SIZE-1,th=0.2; for (let i=0;i<SIZE/2;i++) if (Math.abs(buf[i])<th){ r1=i; break; } for (let i=1;i<SIZE/2;i++) if (Math.abs(buf[SIZE-i])<th){ r2=SIZE-i; break; } buf = buf.slice(r1,r2); const newSize=buf.length; const c = new Array(newSize).fill(0); for (let i=0;i<newSize;i++) for (let j=0;j<newSize-i;j++) c[i]+=buf[j]*buf[j+i]; let d=0; while(c[d]>c[d+1]) d++; let maxval=-1,maxpos=-1; for (let i=d;i<newSize;i++){ if (c[i]>maxval){ maxval=c[i]; maxpos=i; } } if (maxpos===-1) return null; const T0 = maxpos; return sampleRate/T0; }

  function speechDetected(){ lastSpeechTime = performance.now(); }

  function startRecording(){ const seconds = getSelectedSeconds(); updateTimer(); startTimer(seconds); startRecognition(); }
  function stopRecording(){ if (recognition) stopRecognition(); if (timerId) cancelAnimationFrame(timerId); timerId=null; progressBar.style.width='100%'; timeLeftEl.textContent='00:00'; }

  function computeMetricsFromText(txt, speakingMs){ const words = txt.trim().split(/\s+/).filter(Boolean).length || 0; const wpm = speakingMs>0 ? Math.round(words/(speakingMs/60000)) : 0; const lower = txt.toLowerCase(); let fillerCount=0; FILLERS.forEach(f=>{ const rx = new RegExp('\\b'+escapeRegExp(f)+'\\b','g'); const m = lower.match(rx); if (m) fillerCount+=m.length; }); const fillerPerMin = speakingMs>0 ? (fillerCount/(speakingMs/60000)).toFixed(1) : 0; const pauseCount = pauses.length; const longestPause = pauses.reduce((m,p)=>Math.max(m,p.end-p.start),0); const unique = new Set(txt.toLowerCase().replace(/[^a-z\\s]/g,'').split(/\\s+/).filter(Boolean)); const ttr = words>0 ? (unique.size/words).toFixed(2) : 0; const pitchRange = pitchSamples.length ? Math.round(Math.max(...pitchSamples)-Math.min(...pitchSamples)) : 0; return {words,wpm,fillerCount,fillerPerMin,pauseCount,longestPause,ttr,pitchRange}; }

  function computeLiveMetrics(){ const txt = transcriptEl.textContent || ''; const speakingMs = Math.max(1, performance.now() - (startTime || performance.now())); const m = computeMetricsFromText(txt, speakingMs); renderMetrics(m); }

  function renderMetrics(m){ metricsEl.innerHTML=''; const blocks = [['WPM',m.wpm],['Words',m.words],['Fillers/min',m.fillerPerMin],['Pauses',m.pauseCount],['Longest pause (ms)',Math.round(m.longestPause)],['TTR',m.ttr],['Pitch range (Hz)',m.pitchRange]]; blocks.forEach(b=>{ const d=document.createElement('div'); d.className='metric'; d.innerHTML = `<div style="font-weight:700">${b[1]}</div><div class="small">${b[0]}</div>`; metricsEl.appendChild(d); }); offerSuggestion(m); }

  function offerSuggestion(m){ suggestionEl.style.display='block'; let text=''; if (m.wpm>190) text='You speak fast — add 300–500ms pauses at commas.'; else if (m.wpm<110) text='You speak slowly — try raising energy a bit.'; else text='Pace is good. Reduce fillers for clarity.'; if (m.fillerPerMin>3) text='Too many filler words. Pause briefly instead.'; suggestionEl.textContent = text; }

  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&'); }

  // Save sessions
  function saveSession(){ const now = new Date().toISOString(); const txt = transcriptEl.textContent.trim(); if (!txt){ alert('No transcript to save.'); return; } const speakingMs = Math.max(1, (endTime? endTime: performance.now()) - (startTime || performance.now())); const m = computeMetricsFromText(txt, speakingMs); const session = {id: now, prompt: promptEl.value, transcript: txt, metrics: m, date: now}; const arr = JSON.parse(localStorage.getItem('orator_history')||'[]'); arr.unshift(session); localStorage.setItem('orator_history', JSON.stringify(arr)); refreshHistory(); saveBtn.disabled=true; }

  function refreshHistory(){ const arr = JSON.parse(localStorage.getItem('orator_history')||'[]'); if (!arr.length){ historyEl.innerHTML = '<div class="small">No sessions yet.</div>'; return; } const rows = arr.map(s=>`<div style="padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.02)"><div style="display:flex;justify-content:space-between"><div><strong>${s.prompt}</strong><div class="small">${new Date(s.date).toLocaleString()}</div></div><div style="text-align:right"><div class="small">WPM: ${s.metrics.wpm}</div><div style="margin-top:6px"><button class="smallBtn" data-id="${s.id}" onclick="replaySession('${s.id}')">Replay</button> <button class="smallBtn" data-id="${s.id}" onclick="deleteSession('${s.id}')">Delete</button></div></div></div><div style="margin-top:6px;font-size:13px">${escapeHtmlPreview(s.transcript)}</div></div>`).join(''); historyEl.innerHTML = rows; }

  window.replaySession = function(id){ const arr = JSON.parse(localStorage.getItem('orator_history')||'[]'); const s = arr.find(x=>x.id===id); if(!s) return; transcriptEl.textContent = s.transcript; renderMetrics(s.metrics); }
  window.deleteSession = function(id){ let arr = JSON.parse(localStorage.getItem('orator_history')||'[]'); arr = arr.filter(x=>x.id!==id); localStorage.setItem('orator_history', JSON.stringify(arr)); refreshHistory(); }
  function escapeHtmlPreview(s){ return s.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

  function exportCSV(){ const arr = JSON.parse(localStorage.getItem('orator_history')||'[]'); if (!arr.length){ alert('No sessions to export.'); return; } const header = ['date','prompt','words','wpm','fillers','pauses','longestPause','ttr','pitchRange','transcript']; const lines=[header.join(',')]; arr.forEach(s=>{ const row=[s.date,`"${s.prompt.replace(/"/g,'""')}"`,s.metrics.words,s.metrics.wpm,s.metrics.fillerCount,s.metrics.pauseCount,Math.round(s.metrics.longestPause),s.metrics.ttr,s.metrics.pitchRange,`"${s.transcript.replace(/"/g,'""') }"`]; lines.push(row.join(',')); }); const blob = new Blob([lines.join('\n')], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='orator_history.csv'; a.click(); URL.revokeObjectURL(url); }

  // UI wiring
  startBtn.addEventListener('click', ()=>{ startBtn.disabled=true; stopBtn.disabled=false; saveBtn.disabled=true; startRecording(); });
  stopBtn.addEventListener('click', ()=>{ stopRecording(); });
  saveBtn.addEventListener('click', ()=>{ saveSession(); });
  exportBtn.addEventListener('click', ()=>{ exportCSV(); });
  $('clearHistory').addEventListener('click', ()=>{ if (confirm('Clear all saved sessions?')){ localStorage.removeItem('orator_history'); refreshHistory(); } });
  $('demoFill').addEventListener('click', ()=>{ const sample='Hello, my name is Alex. I work on simple products that help people learn. In this short pitch I will show why our tool helps learners stay engaged.'; transcriptEl.textContent = sample; startTime = performance.now() - 35000; computeLiveMetrics(); saveBtn.disabled=false; });

  transcriptEl.addEventListener('input', ()=>{ saveBtn.disabled = transcriptEl.textContent.trim().length===0; computeLiveMetrics(); });

  // helpers
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&'); }

  // init
  refreshHistory(); updateTimer(); if (!supportsSpeechRecognition()){ statusEl.textContent='● speech API not available — paste transcript manually'; startBtn.disabled=false; }

  </script>
</body>
</html>
